import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  onSnapshot, 
  setDoc, 
  updateDoc, 
  collection, 
  addDoc, 
  deleteDoc, 
  query 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// Firebase Configuration
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-store-v3';

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã - –¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–≤–æ–π ID, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
const ADMIN_IDS = ['1827728855', '7861794182']; 

const CATEGORIES = [
  { id: 'all', name: '–í—Å–µ', icon: 'üíé' },
  { id: 'schemes', name: '–°—Ö–µ–º—ã', icon: 'üìä' },
  { id: 'abuses', name: '–ê–±—É–∑—ã', icon: '‚ö°' },
  { id: 'softs', name: '–°–æ—Ñ—Ç—ã', icon: 'üíª' },
  { id: 'manuals', name: '–ú–∞–Ω—É–∞–ª—ã', icon: 'üìö' }
];

export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [adminSubTab, setAdminSubTab] = useState('req');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [user, setUser] = useState(null);
  const [profileData, setProfileData] = useState({ balance: 0, name: '...', purchases: [] });
  const [depositRequests, setDepositRequests] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [products, setProducts] = useState([]);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  const [isLoading, setIsLoading] = useState(true);
  const [dbError, setDbError] = useState(null);
  const [isDepositModal, setIsDepositModal] = useState(false);
  const [isAdminProductModal, setIsAdminProductModal] = useState(false);
  const [paymentStep, setPaymentStep] = useState(1);
  const [depositAmount, setDepositAmount] = useState(500);
  const [selectedPhoto, setSelectedPhoto] = useState(null);
  const [toast, setToast] = useState({ show: false, text: '', isErr: false });
  const [isProcessing, setIsProcessing] = useState(false);

  // –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
  const [newProduct, setNewProduct] = useState({ title: '', price: '', category: '–°—Ö–µ–º—ã', content: '', desc: '' });

  const tg = window.Telegram?.WebApp;

  useEffect(() => {
    if (tg) {
      tg.expand();
      tg.ready();
    }

    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        setDbError("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å Firebase.");
      }
    };

    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, (firebaseUser) => {
        setUser(firebaseUser);
        if (firebaseUser) setIsLoading(false);
    });
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    const tgUser = tg?.initDataUnsafe?.user;
    const userId = tgUser ? tgUser.id.toString() : user.uid;

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø—Ä–æ—Ñ–∏–ª—å
    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
    const unsubProfile = onSnapshot(userRef, (snap) => {
      if (snap.exists()) {
        setProfileData(snap.data());
        setDbError(null);
      } else {
        setDoc(userRef, { 
          balance: 0, 
          name: tgUser?.first_name || 'User', 
          username: tgUser?.username || '', 
          userId, 
          purchases: [] 
        });
      }
    }, (err) => {
        if (err.code === 'permission-denied') setDbError("–ù–∞–∂–º–∏—Ç–µ PUBLISH –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Rules!");
    });

    // –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä—ã
    const unsubProducts = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
      const p = [];
      snap.forEach(d => p.push({ id: d.id, ...d.data() }));
      setProducts(p);
    });

    // –ê–¥–º–∏–Ω—Å–∫–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    let unsubReqs, unsubUsers;
    if (ADMIN_IDS.includes(userId)) {
      unsubReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), (snap) => {
        const r = [];
        snap.forEach(d => r.push({ id: d.id, ...d.data() }));
        setDepositRequests(r);
      });
      unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
        const u = [];
        snap.forEach(d => u.push(d.data()));
        setAllUsers(u);
      });
    }

    return () => { unsubProfile(); unsubProducts(); unsubReqs?.(); unsubUsers?.(); };
  }, [user]);

  const showToast = (text, isErr = false) => {
    setToast({ show: true, text, isErr });
    setTimeout(() => setToast({ show: false, text: '', isErr: false }), 2500);
  };

  const addProduct = async () => {
    if (!newProduct.title || !newProduct.price) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", true);
    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
        ...newProduct,
        price: Number(newProduct.price),
        timestamp: Date.now()
    });
    showToast("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
    setIsAdminProductModal(false);
  };

  const approveDeposit = async (req) => {
    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', req.userId);
    const userDoc = await getDoc(userRef);
    if (userDoc.exists()) {
        await updateDoc(userRef, { balance: (userDoc.data().balance || 0) + req.amount });
        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', req.id));
        showToast("–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω");
    }
  };

  const buyProduct = async (product) => {
    const userId = tg?.initDataUnsafe?.user?.id.toString() || user.uid;
    if (profileData.balance < product.price) return showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", true);
    
    setIsProcessing(true);
    try {
      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
      const updatedPurchases = [...(profileData.purchases || []), { 
        id: product.id, 
        title: product.title, 
        content: product.content, 
        date: Date.now() 
      }];

      await updateDoc(userRef, {
        balance: profileData.balance - product.price,
        purchases: updatedPurchases
      });
      showToast("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!");
    } catch (e) { showToast("–û—à–∏–±–∫–∞", true); }
    setIsProcessing(false);
  };

  if (dbError || isLoading) {
    return (
      <div className="min-h-screen bg-[#0a0a0a] flex flex-col items-center justify-center p-10 text-center text-white">
        {dbError ? (
            <div className="animate-in fade-in zoom-in-95">
                <p className="text-red-500 font-black uppercase text-xs tracking-widest mb-4">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</p>
                <p className="text-white/40 text-[10px] mb-8">{dbError}</p>
                <button onClick={() => window.location.reload()} className="px-6 py-3 bg-white/5 border border-white/10 rounded-xl text-[10px] uppercase font-bold">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
        ) : <div className="w-8 h-8 border-2 border-white/10 border-t-white rounded-full animate-spin"></div>}
      </div>
    );
  }

  const isAdmin = tg?.initDataUnsafe?.user && ADMIN_IDS.includes(tg.initDataUnsafe.user.id.toString());

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans pb-32">
      {toast.show && (
        <div className={`fixed top-8 left-1/2 -translate-x-1/2 z-[3000] px-6 py-3 rounded-full font-black uppercase text-[10px] tracking-widest border border-white/10 animate-in fade-in slide-in-from-top-4 ${toast.isErr ? 'bg-red-600' : 'bg-green-600'}`}>
          {toast.text}
        </div>
      )}

      <div className="max-w-[480px] mx-auto px-5 pt-8">
        {activeTab === 'home' && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <div className="relative h-60 rounded-[40px] overflow-hidden border border-white/10 bg-black shadow-2xl">
              <img src="https://imgfy.ru/ib/HqoMAyXqRBc9QEn_1771516584.jpg" className="w-full h-full object-cover opacity-50" />
              <div className="absolute inset-0 bg-gradient-to-t from-black p-8 flex flex-col justify-end">
                <h1 className="text-5xl font-black italic tracking-tighter leading-none mb-2 uppercase">SCHEM<br/>SHOP</h1>
                <p className="text-[10px] text-green-500 font-bold uppercase tracking-[0.2em]">Online & Secure</p>
              </div>
            </div>
            <button onClick={() => setActiveTab('catalog')} className="w-full py-5 bg-white text-black rounded-[25px] font-black uppercase text-xs tracking-widest active:scale-95 transition-all shadow-xl">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</button>
          </div>
        )}

        {activeTab === 'catalog' && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <h2 className="text-3xl font-black italic uppercase">–ú–∞—Ä–∫–µ—Ç</h2>
            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
              {CATEGORIES.map(cat => (
                <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`px-5 py-2.5 rounded-full text-[10px] font-black uppercase border transition-all ${selectedCategory === cat.id ? 'bg-white text-black border-white' : 'bg-white/5 text-gray-500 border-white/5'}`}>
                  {cat.name}
                </button>
              ))}
            </div>
            <div className="flex flex-col gap-4">
              {products.filter(p => selectedCategory === 'all' || p.category === CATEGORIES.find(c => c.id === selectedCategory).name).map(p => (
                <div key={p.id} className="bg-[#111] p-6 rounded-[30px] border border-white/5">
                  <div className="flex justify-between items-start mb-4">
                    <div>
                        <span className="text-[8px] bg-white/5 px-2 py-1 rounded font-bold uppercase text-gray-400">{p.category}</span>
                        <h3 className="text-lg font-black uppercase mt-1 italic">{p.title}</h3>
                    </div>
                    <p className="text-xl font-black text-green-400 italic">{p.price} ‚ÇΩ</p>
                  </div>
                  <p className="text-xs text-gray-500 mb-6">{p.desc}</p>
                  <button onClick={() => buyProduct(p)} className="w-full py-3.5 bg-white/5 border border-white/10 rounded-2xl font-black uppercase text-[10px] tracking-widest active:bg-white active:text-black transition-all">–ö—É–ø–∏—Ç—å</button>
                </div>
              ))}
            </div>
          </div>
        )}

        {activeTab === 'profile' && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <div className="flex flex-col items-center py-6">
              <div className="w-20 h-20 bg-white text-black rounded-[30px] flex items-center justify-center text-3xl font-black italic transform -rotate-3 mb-4">{profileData.name?.[0]}</div>
              <h2 className="text-xl font-black uppercase italic">{profileData.name}</h2>
              <p className="text-[9px] text-gray-600 font-black uppercase tracking-widest mt-1">ID: {profileData.userId}</p>
            </div>
            <div className="bg-[#111] p-8 rounded-[40px] border border-white/5 text-center">
              <p className="text-[10px] text-gray-500 font-black uppercase mb-1">–ë–∞–ª–∞–Ω—Å</p>
              <p className="text-5xl font-black text-green-400 italic mb-8">{(profileData.balance || 0).toFixed(0)} ‚ÇΩ</p>
              <button onClick={() => setIsDepositModal(true)} className="w-full py-4 bg-green-600 rounded-2xl font-black uppercase text-[11px] tracking-widest active:scale-95">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
            </div>
            <div className="flex flex-col gap-4 mt-4">
                <h3 className="text-[10px] font-black uppercase text-gray-500 px-2 tracking-widest italic">–í–∞—à–∏ –ø–æ–∫—É–ø–∫–∏</h3>
                {profileData.purchases?.length > 0 ? profileData.purchases.map((pur, i) => (
                    <div key={i} className="bg-[#111] p-5 rounded-[25px] border border-white/5">
                        <p className="font-black text-xs uppercase mb-2 italic">{pur.title}</p>
                        <div className="bg-black/50 p-4 rounded-xl border border-white/5 select-all">
                            <p className="text-[10px] text-green-500 font-mono">{pur.content}</p>
                        </div>
                    </div>
                )) : <p className="text-center py-10 opacity-20 text-[9px] font-black uppercase">–ü—É—Å—Ç–æ</p>}
            </div>
          </div>
        )}

        {activeTab === 'admin' && (
            <div className="flex flex-col gap-6 animate-in fade-in">
                <h2 className="text-3xl font-black italic uppercase">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h2>
                <div className="flex bg-white/5 p-1 rounded-2xl border border-white/5">
                    <button onClick={() => setAdminSubTab('req')} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${adminSubTab === 'req' ? 'bg-white text-black' : 'text-gray-500'}`}>–ó–∞—è–≤–∫–∏ ({depositRequests.length})</button>
                    <button onClick={() => setAdminSubTab('prod')} className={`flex-1 py-3 rounded-xl text-[10px] font-black uppercase ${adminSubTab === 'prod' ? 'bg-white text-black' : 'text-gray-500'}`}>–¢–æ–≤–∞—Ä—ã</button>
                </div>
                {adminSubTab === 'req' ? (
                    <div className="flex flex-col gap-4">
                        {depositRequests.map(req => (
                            <div key={req.id} className="bg-[#111] p-5 rounded-3xl border border-white/5 flex flex-col gap-4">
                                <div className="flex justify-between items-center">
                                    <p className="font-black italic uppercase text-xs">{req.userName}</p>
                                    <p className="text-green-400 font-black">+{req.amount} ‚ÇΩ</p>
                                </div>
                                <img src={req.photoUrl} className="w-full h-40 object-cover rounded-2xl border border-white/5" onClick={() => window.open(req.photoUrl)} />
                                <button onClick={() => approveDeposit(req)} className="w-full py-3 bg-green-600 rounded-xl font-black uppercase text-[10px]">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="flex flex-col gap-4">
                        <button onClick={() => setIsAdminProductModal(true)} className="w-full py-4 border-2 border-dashed border-white/10 rounded-2xl text-[10px] font-black uppercase text-gray-500">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
                        {products.map(p => (
                            <div key={p.id} className="bg-[#111] p-4 rounded-2xl border border-white/5 flex justify-between items-center">
                                <p className="text-[10px] font-black uppercase">{p.title}</p>
                                <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', p.id))} className="text-red-500 font-black text-[10px] uppercase">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        )}
      </div>

      <nav className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-[420px] bg-black/80 backdrop-blur-2xl p-2 rounded-[30px] border border-white/10 flex justify-between z-[100] shadow-2xl">
        {[
          { id: 'home', icon: 'üè†', label: '–î–æ–º–æ–π' },
          { id: 'catalog', icon: 'üíé', label: '–ú–∞—Ä–∫–µ—Ç' },
          { id: 'profile', icon: 'üë§', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
          ...(isAdmin ? [{ id: 'admin', icon: '‚ö°', label: '–ê–¥–º–∏–Ω' }] : [])
        ].map(item => (
          <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex-1 flex flex-col items-center justify-center gap-1 py-3 rounded-2xl transition-all ${activeTab === item.id ? 'bg-white text-black scale-105' : 'text-gray-500'}`}>
            <span className="text-lg">{item.icon}</span>
            <span className="text-[8px] font-black uppercase tracking-tighter">{item.label}</span>
          </button>
        ))}
      </nav>

      {/* –ú–æ–¥–∞–ª–∫–∏ (–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞) */}
      {isDepositModal && (
          <div className="fixed inset-0 bg-black/95 z-[2000] flex items-center justify-center p-6 backdrop-blur-xl animate-in fade-in">
              <div className="bg-[#111] w-full max-w-[380px] p-8 rounded-[40px] border border-white/5">
                <h3 className="text-center font-black uppercase italic mb-8">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</h3>
                {paymentStep === 1 ? (
                    <>
                        <input type="number" value={depositAmount} onChange={e => setDepositAmount(e.target.value)} className="w-full bg-black border border-white/10 p-5 rounded-2xl text-center text-3xl font-black text-green-400 italic mb-6 outline-none" />
                        <button onClick={() => setPaymentStep(2)} className="w-full py-4 bg-white text-black rounded-2xl font-black uppercase text-[11px]">–î–∞–ª–µ–µ</button>
                    </>
                ) : (
                    <div className="flex flex-col gap-4">
                        <div className="bg-black p-5 rounded-2xl border border-white/5 text-center">
                            <p className="text-green-500 font-black text-xl">+79509568954</p>
                            <p className="text-[8px] text-gray-600 font-black uppercase mt-1">–û–ó–û–ù / –°–ë–ü</p>
                        </div>
                        <div onClick={() => document.getElementById('up-check').click()} className="h-32 border-2 border-dashed border-white/10 rounded-2xl flex items-center justify-center cursor-pointer overflow-hidden">
                            <input type="file" id="up-check" hidden onChange={e => {
                                const r = new FileReader(); r.onload = (ev) => setSelectedPhoto(ev.target.result); r.readAsDataURL(e.target.files[0]);
                            }} />
                            {selectedPhoto ? <img src={selectedPhoto} className="w-full h-full object-cover" /> : <p className="text-[9px] font-black uppercase opacity-20 tracking-widest">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —á–µ–∫</p>}
                        </div>
                        <button onClick={handleDepositSubmit} className="w-full py-4 bg-green-600 rounded-2xl font-black uppercase text-[11px]">–Ø –æ–ø–ª–∞—Ç–∏–ª</button>
                    </div>
                )}
                <button onClick={() => { setIsDepositModal(false); setPaymentStep(1); }} className="w-full mt-4 text-[9px] font-black uppercase text-white/20">–û—Ç–º–µ–Ω–∞</button>
              </div>
          </div>
      )}

      {isAdminProductModal && (
          <div className="fixed inset-0 bg-black/95 z-[2000] flex items-center justify-center p-6 animate-in fade-in">
              <div className="bg-[#111] w-full max-w-[400px] p-8 rounded-[40px] border border-white/5 flex flex-col gap-4">
                  <h3 className="font-black uppercase italic text-center mb-4">–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
                  <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="bg-black p-4 rounded-xl border border-white/10 outline-none text-xs" onChange={e => setNewProduct({...newProduct, title: e.target.value})} />
                  <input placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" type="number" className="bg-black p-4 rounded-xl border border-white/10 outline-none text-xs" onChange={e => setNewProduct({...newProduct, price: e.target.value})} />
                  <select className="bg-black p-4 rounded-xl border border-white/10 outline-none text-xs text-gray-400" onChange={e => setNewProduct({...newProduct, category: e.target.value})}>
                      {CATEGORIES.filter(c => c.id !== 'all').map(c => <option key={c.id}>{c.name}</option>)}
                  </select>
                  <textarea placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" className="bg-black p-4 rounded-xl border border-white/10 outline-none text-xs h-20" onChange={e => setNewProduct({...newProduct, desc: e.target.value})} />
                  <textarea placeholder="–°–æ–¥–µ—Ä–∂–∏–º–æ–µ (—Å—Å—ã–ª–∫–∞/–∫–æ–¥)" className="bg-black p-4 rounded-xl border border-white/10 outline-none text-[10px] font-mono h-20" onChange={e => setNewProduct({...newProduct, content: e.target.value})} />
                  <button onClick={addProduct} className="w-full py-4 bg-white text-black rounded-xl font-black uppercase text-xs">–°–æ–∑–¥–∞—Ç—å</button>
                  <button onClick={() => setIsAdminProductModal(false)} className="text-[9px] uppercase font-black opacity-30 mt-2">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
          </div>
      )}
    </div>
  );

  async function handleDepositSubmit() {
    if (!selectedPhoto) return showToast("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫", true);
    setIsProcessing(true);
    const userId = tg?.initDataUnsafe?.user?.id.toString() || user.uid;
    const userName = tg?.initDataUnsafe?.user?.first_name || '–¢—Ä–µ–π–¥–µ—Ä';
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), {
        userId, userName, amount: Number(depositAmount), photoUrl: selectedPhoto, timestamp: Date.now()
      });
      showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
      setIsDepositModal(false); setPaymentStep(1); setSelectedPhoto(null);
    } catch (e) { showToast("–û—à–∏–±–∫–∞", true); }
    setIsProcessing(false);
  }
}