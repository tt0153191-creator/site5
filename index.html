<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Schem Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0a0a0a; 
            color: white; 
            -webkit-tap-highlight-color: transparent; 
            overflow-x: hidden;
        }
        .active-tab { background: white !important; color: black !important; transform: translateY(-2px); }
        .glass { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(10px); }
        .animate-fade { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="no-scrollbar">

    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div id="app-loader" class="fixed inset-0 flex flex-col items-center justify-center bg-[#0a0a0a] z-[3000]">
        <div class="w-10 h-10 border-2 border-white/10 border-t-white rounded-full animate-spin mb-6"></div>
        <p id="loader-text" class="text-[9px] font-black uppercase tracking-[0.3em] opacity-40 text-center px-6">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏...</p>
    </div>

    <div id="main-content" class="max-w-[480px] mx-auto px-6 pt-10 pb-32 min-h-screen opacity-0 transition-opacity duration-500">
        <!-- –°—é–¥–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç -->
    </div>

    <!-- –¢–∞–±-–±–∞—Ä -->
    <div id="nav-bar" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-[400px] glass p-2 rounded-[32px] flex justify-between z-[100] shadow-2xl hidden">
        <button onclick="switchTab('home')" id="btn-home" class="flex-1 flex flex-col items-center py-3 rounded-[24px] transition-all duration-300 text-gray-500">
            <span class="text-xl">üè†</span>
            <span class="text-[7px] font-black uppercase mt-1 tracking-wider">–ì–ª–∞–≤–Ω–∞—è</span>
        </button>
        <button onclick="switchTab('catalog')" id="btn-catalog" class="flex-1 flex flex-col items-center py-3 rounded-[24px] transition-all duration-300 text-gray-500">
            <span class="text-xl">üíé</span>
            <span class="text-[7px] font-black uppercase mt-1 tracking-wider">–ú–∞—Ä–∫–µ—Ç</span>
        </button>
        <button onclick="switchTab('profile')" id="btn-profile" class="flex-1 flex flex-col items-center py-3 rounded-[24px] transition-all duration-300 text-gray-500">
            <span class="text-xl">üë§</span>
            <span class="text-[7px] font-black uppercase mt-1 tracking-wider">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
        <button onclick="switchTab('admin')" id="btn-admin" class="flex-1 flex flex-col items-center py-3 rounded-[24px] transition-all duration-300 text-gray-500 hidden">
            <span class="text-xl">‚ö°</span>
            <span class="text-[7px] font-black uppercase mt-1 tracking-wider">–ê–¥–º–∏–Ω</span>
        </button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, collection, getDoc, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ —Å—Ä–µ–¥—ã
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : "digital-store-v3";
        const ADMIN_IDS = ['1827728855', '7861794182'];

        let userData = { balance: 0, purchases: [], userId: '' };
        let products = [];
        let depositRequests = [];
        let currentTab = 'home';
        let isAuthStarted = false;

        const tg = window.Telegram?.WebApp;

        // –≠–ª–µ–º–µ–Ω—Ç—ã UI
        const loaderText = document.getElementById('loader-text');

        async function init() {
            if (tg) {
                tg.expand();
                tg.ready();
                tg.headerColor = '#0a0a0a';
                tg.backgroundColor = '#0a0a0a';
            }

            // –®–ê–ì 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–ü—Ä–∞–≤–∏–ª–æ 3: –°–Ω–∞—á–∞–ª–∞ Auth, –ø–æ—Ç–æ–º Query)
            const performSignIn = async (retries = 5) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                        return; // –£—Å–ø–µ—Ö
                    } catch (e) {
                        const delay = Math.pow(2, i) * 1000;
                        if (i === retries - 1) throw e;
                        await new Promise(r => setTimeout(r, delay));
                    }
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const userId = tg?.initDataUnsafe?.user?.id?.toString() || user.uid;
                    const userName = tg?.initDataUnsafe?.user?.first_name || "–¢—Ä–µ–π–¥–µ—Ä";
                    setupListeners(userId, userName);
                } else if (!isAuthStarted) {
                    isAuthStarted = true;
                    performSignIn().catch(err => {
                        showError("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: " + err.message);
                    });
                }
            });
        }

        function setupListeners(userId, userName) {
            if (!auth.currentUser) return;

            // –®–ê–ì 2: –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (–ü—Ä–∞–≤–∏–ª–æ 1: –°—Ç—Ä–æ–≥–∏–µ –ø—É—Ç–∏)
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            onSnapshot(userRef, (snap) => {
                if (snap.exists()) {
                    userData = snap.data();
                } else {
                    const initial = { userId, name: userName, balance: 0, purchases: [], createdAt: Date.now() };
                    setDoc(userRef, initial).catch(e => console.error("Create User Error:", e));
                    userData = initial;
                }
                
                if (ADMIN_IDS.includes(userId)) {
                    document.getElementById('btn-admin').classList.remove('hidden');
                    setupAdminListeners();
                }
                
                hideLoader();
                render();
            }, (err) => {
                console.error("Firestore Permission Error:", err);
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∞–≤, –≤—ã–≤–æ–¥–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                showError(`–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ Cloud Firestore (–Ω–µ Realtime DB) –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –ø—É—Ç–∏ /artifacts/${appId}/...`);
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'products'), (snap) => {
                products = [];
                snap.forEach(d => products.push({id: d.id, ...d.data()}));
                render();
            }, (err) => console.warn("Products sync error (likely empty collection):", err));
        }

        function setupAdminListeners() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), (snap) => {
                depositRequests = [];
                snap.forEach(d => depositRequests.push({id: d.id, ...d.data()}));
                if (currentTab === 'admin') render();
            }, (err) => console.error("Admin listener error:", err));
        }

        function hideLoader() {
            const loader = document.getElementById('app-loader');
            if (loader) loader.classList.add('hidden');
            document.getElementById('main-content').classList.remove('opacity-0');
            document.getElementById('nav-bar').classList.remove('hidden');
        }

        function showError(msg) {
            if (loaderText) {
                loaderText.innerHTML = `<span class="text-red-500 font-bold block mb-4">–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –°–ë–û–ô</span><span class="text-white/60 lowercase leading-relaxed">${msg}</span>`;
            }
            const spinner = document.querySelector('.animate-spin');
            if (spinner) spinner.style.display = 'none';
        }

        window.switchTab = (tab) => {
            currentTab = tab;
            render();
            if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        };

        function render() {
            const container = document.getElementById('main-content');
            if (!container) return;

            ['home', 'catalog', 'profile', 'admin'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if (btn) {
                    if (currentTab === t) btn.classList.add('active-tab');
                    else btn.classList.remove('active-tab');
                }
            });

            if (currentTab === 'home') {
                container.innerHTML = `
                    <div class="space-y-8 animate-fade">
                        <div class="relative h-72 rounded-[48px] overflow-hidden border border-white/5 shadow-2xl">
                            <img src="https://imgfy.ru/ib/HqoMAyXqRBc9QEn_1771516584.jpg" class="w-full h-full object-cover opacity-60">
                            <div class="absolute inset-0 bg-gradient-to-t from-[#0a0a0a] via-transparent p-10 flex flex-col justify-end">
                                <h1 class="text-5xl font-black italic uppercase tracking-tighter leading-[0.85]">SCHEM<br>SHOP</h1>
                                <p class="text-[9px] text-white/40 font-black uppercase mt-4 tracking-[0.3em]">Premium Digital Access</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="glass p-8 rounded-[38px] text-center">
                                <p class="text-[8px] text-white/30 font-black uppercase mb-1 tracking-widest">–ö–æ—à–µ–ª–µ–∫</p>
                                <p class="text-3xl font-black italic text-green-400 leading-none">${userData.balance} ‚ÇΩ</p>
                            </div>
                            <div class="glass p-8 rounded-[38px] text-center">
                                <p class="text-[8px] text-white/30 font-black uppercase mb-1 tracking-widest">–ê–∫—Ç–∏–≤</p>
                                <p class="text-3xl font-black italic leading-none">${products.length}</p>
                            </div>
                        </div>

                        <button onclick="switchTab('catalog')" class="w-full py-6 bg-white text-black rounded-[28px] font-black uppercase text-[11px] tracking-[0.2em] shadow-2xl active:scale-[0.97] transition-all">
                            –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞—Ä–∫–µ—Ç
                        </button>
                    </div>
                `;
            } else if (currentTab === 'catalog') {
                container.innerHTML = `
                    <div class="animate-fade">
                        <h2 class="text-4xl font-black italic uppercase mb-10 tracking-tighter">–ú–∞—Ä–∫–µ—Ç</h2>
                        <div class="space-y-4">
                            ${products.map(p => `
                                <div class="glass p-6 rounded-[35px] flex justify-between items-center group">
                                    <div class="max-w-[65%]">
                                        <h3 class="font-black uppercase italic text-sm leading-tight mb-1">${p.title}</h3>
                                        <p class="text-green-400 font-black text-xl italic tracking-tighter">${p.price} ‚ÇΩ</p>
                                    </div>
                                    <button onclick="buyItem('${p.id}')" class="bg-white text-black px-7 py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest active:scale-90 transition-all">–í–∑—è—Ç—å</button>
                                </div>
                            `).join('') || `
                                <div class="py-24 text-center opacity-20">
                                    <p class="font-black uppercase text-[10px] tracking-[0.4em]">–°–∫–ª–∞–¥ –ø—É—Å—Ç</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            } else if (currentTab === 'profile') {
                container.innerHTML = `
                    <div class="animate-fade flex flex-col items-center">
                        <div class="w-24 h-24 bg-white text-black rounded-[38px] flex items-center justify-center text-4xl font-black italic mb-6 shadow-2xl rotate-3">
                            ${userData.name?.[0]}
                        </div>
                        <h2 class="text-2xl font-black uppercase italic mb-1">${userData.name}</h2>
                        <p class="text-[9px] text-white/20 font-black uppercase tracking-[0.3em] mb-12">ID: ${userData.userId}</p>
                        
                        <div class="w-full glass p-10 rounded-[48px] text-center mb-8">
                            <p class="text-[9px] text-white/30 font-black uppercase tracking-[0.3em] mb-3">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
                            <p class="text-6xl font-black text-green-400 italic mb-10">${userData.balance} ‚ÇΩ</p>
                            <button onclick="requestDeposit()" class="w-full bg-green-500 py-5 rounded-[24px] font-black uppercase text-[10px] tracking-widest active:scale-95 transition-all shadow-xl">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            } else if (currentTab === 'admin') {
                container.innerHTML = `
                    <div class="animate-fade">
                        <h2 class="text-2xl font-black uppercase italic mb-8">–ó–∞—è–≤–∫–∏</h2>
                        <div class="space-y-4">
                            ${depositRequests.map(r => `
                                <div class="glass p-6 rounded-[32px] space-y-4">
                                    <div class="flex justify-between items-end">
                                        <div>
                                            <p class="text-[8px] text-white/30 font-black uppercase mb-1">–ö–ª–∏–µ–Ω—Ç</p>
                                            <p class="font-black uppercase italic text-xs">${r.userName}</p>
                                        </div>
                                        <p class="text-2xl font-black italic text-green-400">${r.amount} ‚ÇΩ</p>
                                    </div>
                                    <button onclick="approveDeposit('${r.id}', '${r.userId}', ${r.amount})" class="w-full bg-blue-600 py-4 rounded-xl font-black uppercase text-[10px] tracking-widest">–û–¥–æ–±—Ä–∏—Ç—å</button>
                                </div>
                            `).join('') || '<p class="text-center py-10 opacity-20 text-[10px] font-black uppercase tracking-widest">–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</p>'}
                        </div>
                    </div>
                `;
            }
        }

        window.requestDeposit = async () => {
            const amount = prompt("–ù–∞ –∫–∞–∫—É—é —Å—É–º–º—É –∂–µ–ª–∞–µ—Ç–µ –ø–æ–ø–æ–ª–Ω–∏—Ç—å? (‚ÇΩ)");
            if (!amount || isNaN(amount) || Number(amount) <= 0) return;
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), {
                    userId: userData.userId,
                    userName: userData.name,
                    amount: Number(amount),
                    createdAt: Date.now()
                });
                alert("–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: " + e.message);
            }
        };

        window.approveDeposit = async (reqId, uid, amount) => {
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', uid);
            try {
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    await updateDoc(userRef, { balance: (snap.data().balance || 0) + amount });
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', reqId));
                    alert("–ë–∞–ª–∞–Ω—Å –ø–æ–ø–æ–ª–Ω–µ–Ω!");
                }
            } catch (e) { alert("–û—à–∏–±–∫–∞: " + e.message); }
        };

        window.buyItem = async (id) => {
            const p = products.find(x => x.id === id);
            if (!p) return;
            if (userData.balance < p.price) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");
            
            const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userData.userId);
            try {
                await updateDoc(userRef, {
                    balance: userData.balance - p.price,
                    purchases: [...(userData.purchases || []), { title: p.title, price: p.price, date: Date.now() }]
                });
                alert("–£—Å–ø–µ—à–Ω–æ –∫—É–ø–ª–µ–Ω–æ!");
            } catch (e) { alert("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏: " + e.message); }
        };

        window.onload = init;
    </script>
</body>
</html>