import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  onSnapshot, 
  setDoc, 
  updateDoc, 
  getDoc, 
  collection, 
  addDoc, 
  deleteDoc, 
  query 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';

// Firebase Configuration
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'digital-store-v3';

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
// –î–æ–±–∞–≤–ª–µ–Ω ID 7861794182 –≤ —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
const ADMIN_IDS = ['1827728855', '7861794182'];
const CATEGORIES = [
  { id: 'all', name: '–í—Å–µ', icon: 'üíé' },
  { id: 'schemes', name: '–°—Ö–µ–º—ã', icon: 'üìä' },
  { id: 'abuses', name: '–ê–±—É–∑—ã', icon: '‚ö°' },
  { id: 'softs', name: '–°–æ—Ñ—Ç—ã', icon: 'üíª' },
  { id: 'manuals', name: '–ú–∞–Ω—É–∞–ª—ã', icon: 'üìö' }
];

export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [adminSubTab, setAdminSubTab] = useState('req');
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [user, setUser] = useState(null);
  const [profileData, setProfileData] = useState({ balance: 0, name: '...', purchases: [] });
  const [depositRequests, setDepositRequests] = useState([]);
  const [allUsers, setAllUsers] = useState([]);
  const [products, setProducts] = useState([]);
  
  // –ú–æ–¥–∞–ª–∫–∏ –∏ —Ñ–æ—Ä–º—ã
  const [isDepositModal, setIsDepositModal] = useState(false);
  const [isAdminProductModal, setIsAdminProductModal] = useState(false);
  const [paymentStep, setPaymentStep] = useState(1);
  const [depositAmount, setDepositAmount] = useState(500);
  const [selectedPhoto, setSelectedPhoto] = useState(null);
  const [toast, setToast] = useState({ show: false, text: '', isErr: false });
  const [isProcessing, setIsProcessing] = useState(false);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
  const [newProduct, setNewProduct] = useState({ title: '', price: '', category: '–°—Ö–µ–º—ã', content: '', desc: '' });

  const tg = window.Telegram?.WebApp;

  useEffect(() => {
    if (tg) {
      tg.expand();
      tg.ready();
      if (tg.headerColor) tg.setHeaderColor('#0a0a0a');
    }

    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };

    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, (firebaseUser) => setUser(firebaseUser));
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    const tgUser = tg?.initDataUnsafe?.user;
    const userId = tgUser ? tgUser.id.toString() : '0';

    // –°–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
    const unsubProfile = onSnapshot(userRef, (snap) => {
      if (snap.exists()) setProfileData(snap.data());
      else if (userId !== '0') {
        setDoc(userRef, { 
          balance: 0, 
          name: tgUser?.first_name || 'User', 
          username: tgUser?.username || '', 
          userId, 
          purchases: [] 
        });
      }
    }, (err) => console.error("Profile error:", err));

    // –°–ª—É—à–∞—Ç–µ–ª—å —Ç–æ–≤–∞—Ä–æ–≤
    const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
    const unsubProducts = onSnapshot(productsRef, (snap) => {
      const p = [];
      snap.forEach(d => p.push({ id: d.id, ...d.data() }));
      setProducts(p);
    }, (err) => console.error("Products error:", err));

    let unsubReqs, unsubUsers;
    if (ADMIN_IDS.includes(userId)) {
      unsubReqs = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), (snap) => {
        const r = [];
        snap.forEach(d => r.push({ id: d.id, ...d.data() }));
        setDepositRequests(r);
      }, (err) => console.error("Reqs error:", err));

      unsubUsers = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
        const u = [];
        snap.forEach(d => u.push(d.data()));
        setAllUsers(u);
      }, (err) => console.error("Users error:", err));
    }

    return () => {
      unsubProfile(); unsubProducts();
      unsubReqs?.(); unsubUsers?.();
    };
  }, [user]);

  const showToast = (text, isErr = false) => {
    setToast({ show: true, text, isErr });
    setTimeout(() => setToast({ show: false, text: '', isErr: false }), 2500);
  };

  // --- –î–µ–π—Å—Ç–≤–∏—è –ê–¥–º–∏–Ω–∞ ---
  const addProduct = async () => {
    if (!newProduct.title || !newProduct.price) return showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è", true);
    setIsProcessing(true);
    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
        ...newProduct,
        price: Number(newProduct.price),
        createdAt: Date.now()
      });
      showToast("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω");
      setIsAdminProductModal(false);
      setNewProduct({ title: '', price: '', category: '–°—Ö–µ–º—ã', content: '', desc: '' });
    } catch (e) { showToast("–û—à–∏–±–∫–∞", true); }
    setIsProcessing(false);
  };

  const deleteProduct = async (id) => {
    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'products', id));
    showToast("–£–¥–∞–ª–µ–Ω–æ");
  };

  const editUserBalance = async (userId, newBalance) => {
    const amount = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å:", newBalance);
    if (amount !== null) {
      await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userId), { balance: Number(amount) });
      showToast("–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω");
    }
  };

  // --- –î–µ–π—Å—Ç–≤–∏—è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
  const buyProduct = async (product) => {
    const userId = tg?.initDataUnsafe?.user?.id.toString() || '0';
    if (profileData.balance < product.price) return showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤", true);
    
    setIsProcessing(true);
    try {
      const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
      const updatedPurchases = [...(profileData.purchases || []), { 
        id: product.id, 
        title: product.title, 
        content: product.content, 
        date: Date.now() 
      }];

      await updateDoc(userRef, {
        balance: profileData.balance - product.price,
        purchases: updatedPurchases
      });

      showToast("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!");
    } catch (e) { showToast("–û—à–∏–±–∫–∞ –ø–æ–∫—É–ø–∫–∏", true); }
    setIsProcessing(false);
  };

  const handleDepositSubmit = async () => {
    if (!selectedPhoto) return showToast("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ–∫", true);
    setIsProcessing(true);
    const userId = tg?.initDataUnsafe?.user?.id.toString() || '0';
    const userName = tg?.initDataUnsafe?.user?.first_name || 'Guest';

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deposit_requests'), {
        userId, userName, amount: Number(depositAmount), photoUrl: selectedPhoto, timestamp: Date.now()
      });
      showToast("–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");
      setIsDepositModal(false);
      setPaymentStep(1);
      setSelectedPhoto(null);
    } catch (e) { showToast("–û—à–∏–±–∫–∞", true); }
    setIsProcessing(false);
  };

  const isAdmin = tg?.initDataUnsafe?.user && ADMIN_IDS.includes(tg.initDataUnsafe.user.id.toString());

  const filteredProducts = selectedCategory === 'all' 
    ? products 
    : products.filter(p => p.category === CATEGORIES.find(c => c.id === selectedCategory)?.name);

  return (
    <div className="min-h-screen bg-[#0a0a0a] text-white font-sans overflow-x-hidden pb-24 selection:bg-green-500/30">
      {/* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */}
      <div className="fixed inset-0 z-[-1] opacity-30">
        {[...Array(30)].map((_, i) => (
          <div key={i} className="absolute bg-white rounded-full animate-pulse" style={{
            width: Math.random() * 2 + 'px', height: Math.random() * 2 + 'px',
            top: Math.random() * 100 + '%', left: Math.random() * 100 + '%',
            animationDuration: (Math.random() * 4 + 2) + 's'
          }} />
        ))}
      </div>

      {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
      {toast.show && (
        <div className={`fixed top-8 left-1/2 -translate-x-1/2 z-[3000] px-6 py-3 rounded-full font-black uppercase text-[10px] tracking-widest shadow-2xl border border-white/10 animate-in fade-in slide-in-from-top-4 ${toast.isErr ? 'bg-red-600' : 'bg-green-600'}`}>
          {toast.text}
        </div>
      )}

      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      <div className="max-w-[480px] mx-auto px-5 pt-8">
        
        {/* –ì–ª–∞–≤–Ω–∞—è */}
        {activeTab === 'home' && (
          <div className="flex flex-col gap-6 animate-in fade-in slide-in-from-bottom-4">
            <div className="relative h-56 rounded-[40px] overflow-hidden border border-white/10 bg-black group shadow-2xl">
              <img src="https://imgfy.ru/ib/HqoMAyXqRBc9QEn_1771516584.jpg" className="w-full h-full object-cover opacity-60 transition-transform duration-700 group-hover:scale-110" />
              <div className="absolute inset-0 bg-gradient-to-t from-black via-black/20 to-transparent flex flex-col justify-end p-8">
                <h1 className="text-5xl font-black italic tracking-tighter leading-none mb-2 uppercase">SCHEM<br/>SHOP</h1>
                <div className="flex items-center gap-2">
                   <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                   <p className="text-[10px] text-gray-400 font-bold uppercase tracking-[0.2em]">Digital Excellence</p>
                </div>
              </div>
            </div>
            
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-[#111] p-6 rounded-[32px] border border-white/5 flex flex-col items-center text-center">
                 <span className="text-2xl mb-2">üíé</span>
                 <p className="text-gray-500 text-[8px] font-black uppercase tracking-widest mb-1">–¢–æ–≤–∞—Ä–æ–≤</p>
                 <p className="text-2xl font-black italic">{products.length}</p>
              </div>
              <div className="bg-[#111] p-6 rounded-[32px] border border-white/5 flex flex-col items-center text-center">
                 <span className="text-2xl mb-2">üî•</span>
                 <p className="text-gray-500 text-[8px] font-black uppercase tracking-widest mb-1">–ê–∫—Ç–∏–≤–Ω—ã—Ö</p>
                 <p className="text-2xl font-black italic">{allUsers.length || '...'}</p>
              </div>
            </div>

            <button onClick={() => setActiveTab('catalog')} className="w-full py-5 bg-white text-black rounded-[28px] font-black uppercase text-xs tracking-widest active:scale-[0.97] transition-all shadow-xl">
              –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞—Ä–∫–µ—Ç
            </button>
          </div>
        )}

        {/* –ú–∞—Ä–∫–µ—Ç */}
        {activeTab === 'catalog' && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <div className="flex items-baseline justify-between mb-2">
               <h2 className="text-3xl font-black italic uppercase tracking-tighter">–ú–∞—Ä–∫–µ—Ç</h2>
               <span className="text-[10px] font-black text-gray-600 uppercase tracking-widest">{filteredProducts.length} –ø–æ–∑–∏—Ü–∏–π</span>
            </div>
            
            {/* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
            <div className="flex gap-2 overflow-x-auto pb-4 no-scrollbar -mx-5 px-5">
              {CATEGORIES.map(cat => (
                <button 
                  key={cat.id} 
                  onClick={() => setSelectedCategory(cat.id)}
                  className={`px-6 py-3 rounded-full text-[10px] font-black uppercase whitespace-nowrap border transition-all flex items-center gap-2 ${selectedCategory === cat.id ? 'bg-white text-black border-white shadow-lg' : 'bg-white/5 text-gray-400 border-white/5'}`}
                >
                  <span>{cat.icon}</span>
                  {cat.name}
                </button>
              ))}
            </div>

            {/* –°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ */}
            <div className="flex flex-col gap-4">
              {filteredProducts.length === 0 ? (
                <div className="text-center py-24">
                  <p className="opacity-10 text-5xl mb-4">üõí</p>
                  <p className="opacity-20 uppercase font-black text-[10px] tracking-widest">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—É—Å—Ç–æ</p>
                </div>
              ) : (
                filteredProducts.map(p => (
                  <div key={p.id} className="bg-[#121212] p-6 rounded-[35px] border border-white/5 flex flex-col gap-4 hover:border-white/20 transition-all">
                    <div className="flex justify-between items-start">
                      <div className="flex-1">
                        <span className="text-[8px] bg-green-500/10 text-green-500 px-3 py-1.5 rounded-full font-black uppercase mb-3 inline-block">
                          {p.category}
                        </span>
                        <h3 className="text-xl font-black uppercase italic leading-tight tracking-tight">{p.title}</h3>
                      </div>
                      <div className="text-right">
                        <p className="text-green-400 font-black text-2xl tracking-tighter">{p.price} ‚ÇΩ</p>
                      </div>
                    </div>
                    <p className="text-[12px] text-gray-500 leading-relaxed font-medium line-clamp-2">{p.desc}</p>
                    <button 
                      onClick={() => buyProduct(p)}
                      disabled={isProcessing}
                      className="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[11px] tracking-widest active:scale-[0.95] transition-all disabled:opacity-50 shadow-lg"
                    >
                      {isProcessing ? '–ü–†–û–í–ï–†–ö–ê...' : '–ö—É–ø–∏—Ç—å'}
                    </button>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {/* –ü—Ä–æ—Ñ–∏–ª—å */}
        {activeTab === 'profile' && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <div className="flex flex-col items-center py-4">
              <div className="relative mb-4">
                 <div className="w-24 h-24 bg-gradient-to-br from-green-500 to-green-900 rounded-[35px] border-4 border-black shadow-2xl flex items-center justify-center text-4xl font-black italic transform rotate-3">
                   {profileData.name?.[0]?.toUpperCase()}
                 </div>
                 <div className="absolute -bottom-2 -right-2 bg-white text-black text-[8px] px-2 py-1 rounded-lg font-black uppercase tracking-tighter">PRO</div>
              </div>
              <h2 className="text-2xl font-black uppercase italic tracking-tighter">{profileData.name}</h2>
              <p className="text-[9px] text-gray-600 font-black uppercase tracking-widest mt-1 opacity-50">ID: {profileData.userId}</p>
            </div>

            {/* –ë–ª–æ–∫ –±–∞–ª–∞–Ω—Å–∞ */}
            <div className="bg-[#111] p-8 rounded-[40px] border border-white/10 flex flex-col items-center relative overflow-hidden">
              <div className="absolute top-0 right-0 p-4 opacity-5 text-6xl font-black italic">‚ÇΩ</div>
              <p className="text-[10px] text-gray-500 font-black uppercase mb-2 tracking-[0.2em]">–í–∞—à –±–∞–ª–∞–Ω—Å</p>
              <p className="text-5xl font-black text-green-400 italic mb-6 tracking-tighter">{(profileData.balance || 0).toFixed(0)}<span className="text-2xl ml-1 not-italic">‚ÇΩ</span></p>
              <button 
                onClick={() => setIsDepositModal(true)} 
                className="w-full py-4 bg-green-600 rounded-2xl font-black uppercase text-[11px] tracking-widest active:scale-95 transition-all shadow-xl"
              >
                –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å
              </button>
            </div>

            <div className="bg-[#111] p-6 rounded-[35px] border border-white/5">
              <div className="flex justify-between items-center mb-6">
                 <h3 className="text-[11px] font-black uppercase text-gray-500 tracking-widest">–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∫—É–ø–æ–∫</h3>
                 <span className="text-[10px] font-black text-white/20">{profileData.purchases?.length || 0}</span>
              </div>
              
              <div className="flex flex-col gap-4">
                {profileData.purchases?.length > 0 ? (
                  profileData.purchases.slice().reverse().map((pur, i) => (
                    <div key={i} className="bg-black/50 p-5 rounded-3xl border border-white/5 hover:border-green-500/20 transition-all">
                      <div className="flex justify-between items-center mb-3">
                        <span className="font-black text-[13px] uppercase italic text-white/90">{pur.title}</span>
                        <span className="text-[9px] text-gray-600 font-bold">{new Date(pur.date).toLocaleDateString()}</span>
                      </div>
                      <div className="bg-green-500/5 p-4 rounded-2xl border border-green-500/10 flex flex-col gap-2">
                        <p className="text-[8px] text-gray-500 uppercase font-black">–í–∞—à –∫–æ–Ω—Ç–µ–Ω—Ç:</p>
                        <p className="break-all text-[11px] text-green-400 font-mono font-bold leading-relaxed">{pur.content}</p>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="text-center py-8 opacity-20 uppercase font-black text-[9px] tracking-widest">–¢—É—Ç –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */}
        {activeTab === 'admin' && isAdmin && (
          <div className="flex flex-col gap-6 animate-in fade-in">
            <div className="flex bg-[#111] p-1.5 rounded-[24px] border border-white/5 shadow-inner">
              {['req', 'users', 'shop'].map(t => (
                <button key={t} onClick={() => setAdminSubTab(t)} className={`flex-1 py-3 text-[10px] font-black uppercase transition-all rounded-xl ${adminSubTab === t ? 'bg-white text-black shadow-lg' : 'text-gray-500 hover:text-white'}`}>
                  {t === 'req' ? '–ó–∞—è–≤–∫–∏' : t === 'users' ? '–Æ–∑–µ—Ä—ã' : '–¢–æ–≤–∞—Ä—ã'}
                </button>
              ))}
            </div>

            {adminSubTab === 'req' && (
              <div className="flex flex-col gap-4">
                {depositRequests.length === 0 ? (
                  <p className="text-center py-20 text-[10px] font-black uppercase opacity-20">–ù–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫</p>
                ) : (
                  depositRequests.map(r => (
                    <div key={r.id} className="bg-black/50 p-6 rounded-[35px] border border-white/5">
                      <div className="flex justify-between mb-4 items-center">
                        <div>
                           <p className="font-black text-xs uppercase italic">{r.userName}</p>
                           <p className="text-[9px] text-gray-600 font-bold uppercase tracking-tighter">ID: {r.userId}</p>
                        </div>
                        <p className="text-green-400 font-black text-xl italic">{r.amount} ‚ÇΩ</p>
                      </div>
                      <div className="relative group mb-5">
                         <img src={r.photoUrl} className="w-full h-48 object-cover rounded-3xl bg-black border border-white/5" />
                      </div>
                      <div className="flex gap-3">
                        <button onClick={async () => {
                          const uRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', r.userId);
                          const uSnap = await getDoc(uRef);
                          const curBal = uSnap.data()?.balance || 0;
                          await updateDoc(uRef, { balance: curBal + r.amount });
                          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', r.id));
                          showToast("–û–¥–æ–±—Ä–µ–Ω–æ");
                        }} className="flex-1 bg-green-600 p-4 rounded-2xl font-black text-[10px] uppercase tracking-widest">–ü—Ä–∏–Ω—è—Ç—å</button>
                        <button onClick={() => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deposit_requests', r.id))} className="flex-1 bg-red-600/10 text-red-500 p-4 rounded-2xl font-black text-[10px] uppercase border border-red-500/20">–û—Ç–∫–∞–∑</button>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}

            {adminSubTab === 'users' && (
              <div className="flex flex-col gap-3">
                {allUsers.map(u => (
                  <div key={u.userId} onClick={() => editUserBalance(u.userId, u.balance)} className="flex justify-between items-center p-5 bg-[#111] rounded-3xl border border-white/5 active:scale-[0.98] transition-all">
                    <div>
                       <p className="text-[11px] font-black uppercase italic tracking-tight">{u.name}</p>
                       <p className="text-[9px] text-gray-600 font-bold uppercase tracking-tighter">ID: {u.userId}</p>
                    </div>
                    <span className="text-green-500 font-black text-sm">{u.balance?.toFixed(0)} ‚ÇΩ</span>
                  </div>
                ))}
              </div>
            )}

            {adminSubTab === 'shop' && (
              <div className="flex flex-col gap-4">
                <button onClick={() => setIsAdminProductModal(true)} className="bg-white text-black p-5 rounded-[28px] font-black uppercase text-[11px] tracking-widest shadow-xl">
                  –°–æ–∑–¥–∞—Ç—å —Ç–æ–≤–∞—Ä +
                </button>
                <div className="flex flex-col gap-3">
                  {products.map(p => (
                    <div key={p.id} className="p-5 bg-[#111] rounded-3xl border border-white/5 flex justify-between items-center">
                      <div>
                         <p className="text-[11px] font-black uppercase italic">{p.title}</p>
                         <p className="text-[9px] text-gray-600 font-bold uppercase">{p.category} ‚Ä¢ {p.price} ‚ÇΩ</p>
                      </div>
                      <button onClick={() => deleteProduct(p.id)} className="bg-red-500/10 p-3 rounded-xl text-red-500">üóëÔ∏è</button>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      {/* –ù–∞–≤–∏–≥–∞—Ü–∏—è */}
      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[92%] max-w-[420px] bg-black/60 backdrop-blur-3xl p-3 rounded-[40px] border border-white/10 flex justify-between items-center z-[100] shadow-2xl">
        {[
          { id: 'home', icon: 'üè†', label: '–ì–ª–∞–≤–Ω–∞—è' },
          { id: 'catalog', icon: 'üíé', label: '–ú–∞—Ä–∫–µ—Ç' },
          { id: 'profile', icon: 'üë§', label: '–ü—Ä–æ—Ñ–∏–ª—å' },
          ...(isAdmin ? [{ id: 'admin', icon: '‚ö°', label: '–ê–¥–º–∏–Ω' }] : [])
        ].map(item => (
          <button 
            key={item.id} 
            onClick={() => setActiveTab(item.id)}
            className={`flex-1 flex flex-col items-center justify-center gap-1.5 transition-all duration-300 py-2 rounded-3xl ${activeTab === item.id ? 'bg-white text-black scale-105 shadow-xl' : 'text-gray-500'}`}
          >
            <span className="text-xl">{item.icon}</span>
            <span className="text-[8px] font-black uppercase tracking-tighter">{item.label}</span>
          </button>
        ))}
      </div>

      {/* –ú–æ–¥–∞–ª–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è */}
      {isDepositModal && (
        <div className="fixed inset-0 bg-black/98 backdrop-blur-3xl z-[2000] flex items-center justify-center p-6 animate-in zoom-in-95">
          <div className="bg-[#111] w-full max-w-[380px] p-8 rounded-[45px] border border-white/5 shadow-2xl">
            {paymentStep === 1 ? (
              <div className="flex flex-col items-center">
                <p className="text-[10px] font-black uppercase text-gray-500 tracking-[0.3em] mb-8">–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞</p>
                <div className="relative w-full mb-8">
                   <input 
                     type="number" 
                     value={depositAmount} 
                     onChange={e => setDepositAmount(e.target.value)} 
                     className="w-full bg-black p-8 rounded-3xl text-center text-5xl font-black text-green-400 outline-none border border-white/5 focus:border-green-500/30 transition-all italic"
                   />
                   <span className="absolute right-6 top-1/2 -translate-y-1/2 text-xl font-black italic opacity-20">‚ÇΩ</span>
                </div>
                <button onClick={() => setPaymentStep(2)} className="w-full bg-white text-black py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
              </div>
            ) : (
              <div className="flex flex-col gap-6">
                <div className="text-center">
                   <p className="text-[10px] font-black uppercase text-gray-500 tracking-widest mb-4">–ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ {depositAmount} ‚ÇΩ</p>
                   <div onClick={() => { 
                     const el = document.createElement('textarea'); el.value = "+79509568954"; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); showToast("–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–æ");
                   }} className="bg-black p-6 rounded-3xl border border-white/5 active:scale-95 transition-all group">
                     <p className="text-green-400 font-black text-2xl tracking-tighter mb-1">+79509568954</p>
                     <p className="text-[9px] text-blue-500 font-black uppercase tracking-tighter group-hover:text-white transition-colors">–û–ó–û–ù / –°–ë–ü (–Ω–∞–∂–º–∏ –¥–ª—è –∫–æ–ø–∏–∏)</p>
                   </div>
                </div>
                
                <input type="file" id="file-up" className="hidden" onChange={e => {
                  const reader = new FileReader(); reader.onload = (ev) => setSelectedPhoto(ev.target.result); reader.readAsDataURL(e.target.files[0]);
                }} />
                
                <div onClick={() => document.getElementById('file-up').click()} className="w-full h-40 border-2 border-dashed border-white/10 rounded-3xl flex flex-col items-center justify-center bg-black overflow-hidden cursor-pointer group hover:border-white/30 transition-all">
                  {selectedPhoto ? (
                    <img src={selectedPhoto} className="w-full h-full object-cover" />
                  ) : (
                    <>
                      <span className="text-2xl mb-2 opacity-30">üì∏</span>
                      <span className="text-[9px] font-black uppercase text-gray-600 group-hover:text-white transition-colors">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —á–µ–∫</span>
                    </>
                  )}
                </div>
                
                <button onClick={handleDepositSubmit} disabled={!selectedPhoto || isProcessing} className="w-full bg-green-600 py-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl disabled:opacity-20 transition-all">
                  {isProcessing ? '–û–¢–ü–†–ê–í–ö–ê...' : '–Ø –æ–ø–ª–∞—Ç–∏–ª'}
                </button>
              </div>
            )}
            <button onClick={() => { setIsDepositModal(false); setPaymentStep(1); setSelectedPhoto(null); }} className="w-full mt-6 text-[9px] text-gray-700 font-black uppercase tracking-widest hover:text-white transition-colors">–ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ñ–∏–ª—å</button>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ */}
      {isAdminProductModal && (
        <div className="fixed inset-0 bg-black/98 backdrop-blur-3xl z-[2000] flex items-center justify-center p-6 animate-in zoom-in-95">
          <div className="bg-[#111] w-full max-w-[380px] p-8 rounded-[45px] border border-white/5 flex flex-col gap-4 shadow-2xl">
            <h3 className="text-center font-black uppercase text-[11px] tracking-[0.3em] mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏</h3>
            <input placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" className="bg-black p-5 rounded-2xl text-[11px] border border-white/5 outline-none font-bold placeholder:text-gray-700" value={newProduct.title} onChange={e => setNewProduct({...newProduct, title: e.target.value})} />
            <input placeholder="–¶–µ–Ω–∞ (‚ÇΩ)" type="number" className="bg-black p-5 rounded-2xl text-[11px] border border-white/5 outline-none font-bold placeholder:text-gray-700 text-green-400" value={newProduct.price} onChange={e => setNewProduct({...newProduct, price: e.target.value})} />
            
            <div className="grid grid-cols-2 gap-2">
              {CATEGORIES.filter(c => c.id !== 'all').map(c => (
                <button 
                  key={c.id} 
                  onClick={() => setNewProduct({...newProduct, category: c.name})}
                  className={`p-3 rounded-xl text-[9px] font-black uppercase border transition-all ${newProduct.category === c.name ? 'bg-white text-black border-white' : 'bg-black text-gray-600 border-white/5'}`}
                >
                  {c.name}
                </button>
              ))}
            </div>

            <textarea placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ" className="bg-black p-5 rounded-2xl text-[11px] border border-white/5 outline-none font-medium h-24 placeholder:text-gray-700 resize-none" value={newProduct.desc} onChange={e => setNewProduct({...newProduct, desc: e.target.value})} />
            <textarea placeholder="–ö–æ–Ω—Ç–µ–Ω—Ç (—Å—Å—ã–ª–∫–∞ –∏–ª–∏ —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã)" className="bg-black p-5 rounded-2xl text-[10px] border border-white/5 outline-none font-mono h-24 placeholder:text-gray-700 resize-none text-blue-400" value={newProduct.content} onChange={e => setNewProduct({...newProduct, content: e.target.value})} />
            
            <button onClick={addProduct} disabled={isProcessing} className="w-full bg-green-600 py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-xl mt-2">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
            <button onClick={() => setIsAdminProductModal(false)} className="w-full text-[9px] text-gray-700 font-black uppercase tracking-widest mt-2 hover:text-white transition-colors">–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
      )}
    </div>
  );
}